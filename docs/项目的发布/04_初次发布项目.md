# 04 初次发布项目

前提：

-   源代码已经上传到 git
-   有一台服务器
-   服务器完成了初步配置，参考“运维/01\_新服务器配置.md”
-   服务器已经连接 github，参考“运维/02\_连接 Github.md”
-   服务器已经安装 docker 和 docker-compose，参考"运维/03_docker 和 compose.md"

使用 `qinyu` 角色 ssh 进入服务器

## 1. 创建 postgres db 的文件夹

在服务器的根目录创建 db 文件夹

```
sudo mkdir -p db/pgData
```

docker-compose.prod.yml 内有如下一行，就是把刚创建的文件夹 mount 给 postgres 用。

```yml
volumes:
    - /db/pgData/:/var/lib/postgresql/data
```

## 2. 从 git 获取项目

cd 到目录 `home/qinyu`，运行 `git clone xxx`，xxx 是项目地址，获取到项目。

## 3. 创建环境变量

cd 到项目文件夹内.

在 `config` 文件夹内创建 `.env.prod`，并输入环境变量
在 `prisma` 文件夹内创建 `.env.db.prod`，并输入环境变量

## 4. 运行 docker

运行:

```
docker-compose --env-file ./prisma/.env.db.prod -f docker-compose.prod.yml up -d
```

查看运行情况

```
docker-compose -f docker-compose.prod.yml ps
```

查看 log

```
docker-compose -f docker-compose.prod.yml logs
```

## 5. 本地环境 migrate deploy

```
yarn migrate:prod
```
